{% extends "_base.html" %}
{% load ucp_extras %}
{% load i18n %}
{% load humanize %}

{% block css %}
  <style type="text/css">
  .full_report{display:none}
  </style>
{% endblock %}

{% block content %}

  {% with this_page=title %}
    {% include "planner/_breadcrumbs.html" %}
  {% endwith %}

      {% with scoring_table=scores status="PRESENT" %}
        {% include "planner/_score.html" %}
      {% endwith %}

  <div class="absolute top-5 right-5 text-center">
    <span class="text-black font-bold block text-5xl">35</span>
    <span class="text-gray-700 text-sm">{{ _("Total score") }}</span>
  </div>

</div> <!-- Closing <main> -->

<div class="mt-20">

  {% for each in garden.targets.all %}

    <section class="break-before-page mb-20 bg-white p-6 rounded-lg shadow-sm">

      <h2>{{ each }}</h2>
      <div class="mb-3">
        <p class="text-sm font-medium text-gray-900 flex justify-between mb-1">
          <span>{{ _("Current score") }}</span>
          <span>{{ scores|get_item:each.name }}</span>
        </p>
        <div aria-hidden="true">
          <div class="overflow-hidden rounded-full bg-gray-200">
            <div style="width: {{ scores|get_item:each.name }}%" class="h-2 rounded-full bg-{{ scores|get_item:each.name|color_calculator }}"></div>
          </div>
        </div>
      </div>

      {% with species_set=feature_species|get_item:each.id %}
        <section class="flex mt-8">
          <div class="flex-1">
            <div class="text-nter">
              <span class="text-black font-bold block text-5xl">{% if species_set.count %}{{ species_set.count }}{% else %}0{% endif %}</span>
              <span class="text-gray-700 text-sm">species found</span>
            </div>
          </div>
          <div class="flex-3">

            {% if species_set.count %}

              <div class="container mx-auto">
                <div class="grid grid-cols-3 gap-2">
                  {% for species in species_set %}
                    <a class="no-underline rounded-lg p-1 hover:bg-gray-200 mb-2" href="{{ species.get_absolute_url }}">
                      <div class="flex items-center gap-x-6">
                        <img 
                          src="{{ species.photo.thumbnail }}" 
                          alt="" 
                          class="size-16 rounded-full outline-1 -outline-offset-1 outline-black/5"
                          title="{{ species.photo.author }}"
                          >
                        <div>
                          <p class="font-semibold tracking-tight text-gray-900 mb-0">
                            {% if species.name_en %}{{ species.name_en }}{% else %}<em>{{ species.name }}</em>{% endif %}
                          </p>
                          {% if species.name_en %}
                            <p class="text-sm font-semibold text-gray-600"><em>{{ species.name }}</em></p>
                          {% endif %}
                        </div>
                      </div>
                    </a>
                  {% endfor %}
                </div>
              </div>

              {% if species_set.count < each.meta_data.score_minimum_species|add:0 %}
                <div class="alert alert-warning mt-5 flex">

                  <div class="mr-3">
                    <i class="fa fa-exclamation-triangle"></i>
                  </div>

                  <div>
                    <strong class="block">
                    {% blocktranslate %}
                       {{ each }} benefit from additional species to support them
                    {% endblocktranslate %}
                    </strong>

                    {% with min=each.meta_data.score_minimum_species name=each|lower %}
                      {% blocktranslate %}
                        You can improve your garden by including additional species that support {{ name }}. 
                        We suggest having at least {{ min }} different species that support {{ name }} in your garden.
                      {% endblocktranslate %}
                    {% endwith %}
                  </div>

                </div>
              {% endif %}

              {% if each.meta_data.score_minimum_flowering %}
                <h3 class="mt-12">{{ _("Flowering overview") }}</h3>

                <table class="w-full text-sm">
                  <thead>
                    <tr>
                      <th class="border-b border-gray-200 px-4 py-2"></th>
                      {% for month, label in months %}
                        <th class="border-b border-gray-200 px-4 py-2">{{ label|first }}</th>
                      {% endfor %}
                    </tr>
                  </thead>
                  <tbody>
                    {% for species in species_set %}
                      <tr>
                        <td class="border-b border-gray-200 px-4 py-1">{% if species.name_en %}{{ species.name_en }}{% else %}<em>{{ species.name }}</em>{% endif %}</td>
                        {% for month, label in months %}
                          <td class="border-b border-gray-200 px-4 py-1 {% if month in species.flowering %}bg-lime-500{% endif %}">
                            {% if month in species.flowering %}
                              <span class="sr-only">{{ _("Yes") }}</span>
                            {% endif %}
                          </td>
                        {% endfor %}
                      </tr>
                    {% endfor %}
                  </tbody>
                </table>

                {% if flowering_failure|get_item:each.id %}
                  <div class="alert alert-warning mt-5 flex">

                    <div class="mr-3">
                      <i class="fa fa-exclamation-triangle"></i>
                    </div>

                    <div>
                      <strong class="block">
                      {% blocktranslate %}
                         {{ each }} can do with more flower-power!
                      {% endblocktranslate %}
                      </strong>

                      {% with min=each.meta_data.score_minimum_flowering %}
                        {% blocktranslate %}
                          You can improve your garden by making sure more plants are flowering in months not currently covered.
                          Improve your garden by having at least {{ min }} different species flowering every month of the year.
                        {% endblocktranslate %}
                      {% endwith %}
                    </div>

                  </div>
                      
                    <div class="flex justify-between mt-3">
                      <div>
                      {% for key,value in flowering_failure|get_item:each.id %}
                        <span class="badge badge-warning">
                        {{ value }}
                        </span>
                      {% endfor %}
                      </div>

                      <a class="btn-blue btn-sm" href="/species/search/"><i class="fa fa-search mr-1"></i> {{ _("Find suggested species") }}</a>  
                    </div>

                {% endif %}
              {% endif %}

              <h3 class="mt-10">{{ _("Scoring overview") }}</h3>

              <table class="table table-striped">
                <thead>
                  <tr>
                    <th>{{ _("Description") }}</th>
                    <th>{{ _("Quantity") }}</th>
                    <th>{{ _("Points/unit") }}</th>
                    <th>
                      {{ _("Points") }}
                      <br>
                      <span class="font-mono">(0-100)</span>
                    </th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td>
                      {{ _("Number of supporting species") }}
                      {% if each.meta_data.score_minimum_flowering %}
                      <br>
                      <span class="badge badge-info mt-1">{{ _("Weight:") }} 50%</span>
                      {% endif %}
                    </td>
                    <td class="font-mono">{{ species_set.count }}</td>
                    <td class="font-mono">{{ each.score_per_species }}</td>
                    <td class="font-mono">
                      {% with score=each.score_per_species|multiply:species_set.count %}
                        {% if score > 100 %}
                          <span class="text-lime-700">100</span>
                          ({{ _("Maximum score reached!") }})
                        {% else %}
                          {{ score|floatformat:0 }}
                        {% endif %}
                      {% endwith %}
                    </td>
                  </tr>
                  {% if each.meta_data.score_minimum_flowering %}
                    {% with score=flowering_success|get_item:each.id %}
                      <tr>
                        <td>
                          {{ _("Number of months with full flowering coverage") }}
                          {% if each.meta_data.score_minimum_species %}
                          <br>
                          <span class="badge badge-info mt-1">{{ _("Weight:") }} 50%</span>
                          {% endif %}
                        </td>
                        <td class="font-mono">{{ score }}</td>
                        <td class="font-mono">8.33</td>
                        <td class="font-mono">
                            {% if score == 12 %}
                              <span class="text-lime-700">100</span>
                              ({{ _("Maximum score reached!") }})
                            {% else %}
                              {{ score|multiply:8.33333333333|floatformat:0 }}
                            {% endif %}
                        </td>
                      </tr>
                    {% endwith %}
                  {% endif %}
                </tbody>
                <tfoot>
                  <th colspan="3">{{ _("Final score") }}</th>
                  <th>{{ scores|get_item:each.name }}</th>
              </table>

            {% else %}

              <div class="relative block w-full rounded-lg border-2 border-dashed border-gray-300 py-20 px-12 text-center hover:border-gray-400">
                <div class="mt-2 block text-sm font-semibold text-gray-900">
                  {{ _("No species added yet.") }}
                  iv><a class="btn btn-blue btn-sm mt-5" href="{% url "planner_suggestions" garden.id %}">{{ _("View suggested plants") }}</a></div>
                </div>
              </div>

            {% endif %}

          </div>
        </section>
      {% endwith %}

    </section>

  {% endfor %}

{% endblock %}
