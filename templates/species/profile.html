{% extends "_base.html" %}
{% load ucp_extras %}

{% block css %}
  <style type="text/css">
    .features svg{max-height:24px;max-width:24px;color:#fff;display:inline}
  </style>
{% endblock %}

{% block content %}

  <div class="absolute top-2 right-2">
    <a href="{% url "species_data" info.id %}" class="btn-blue btn-sm">
      <i class="fa fa-info mr-2"></i>
      {{ _("Data sources") }}
    </a>
  </div>

  <div class="mx-auto max-w-2xl px-4 sm:px-6 pt-5 pb-5 lg:max-w-7xl lg:px-8">
    <div class="lg:grid lg:grid-cols-2 lg:items-start lg:gap-x-8 mb-5">
      <div class="flex flex-col-reverse">
        <div class="mx-auto mt-6 w-full max-w-2xl sm:block lg:max-w-none">
          <div class="grid grid-cols-4 gap-6 gallery" aria-orientation="horizontal" role="tablist">

            {% for each in photos %}
              <button data-target="{{ each.large }}" id="tabs-1-tab-1" class="relative flex h-24 cursor-pointer items-center justify-center rounded-md bg-white text-sm font-medium uppercase text-gray-900 hover:bg-gray-50 focus:outline-hidden focus:ring-3 focus:ring-sky-500/50 focus:ring-offset-4" aria-controls="tabs-1-panel-1" role="tab" type="button" data-credit="{{ each.credit }}">
                <span class="absolute inset-0 rounded-md">
                  <img src="{{ each.thumbnail }}" alt="" class="size-full object-cover">
                </span>
                <span class="pointer-events-none absolute inset-0 rounded-md ring-2 {% if each == photo %}ring-sky-500{% else %}ring-transparent{% endif %} ring-offset-2" ></span>
              </button>
            {% endfor %}

          </div>
        </div>

        <div>
          <div id="headshot" aria-labelledby="headshot" tabindex="0" class="relative">
            <img src="{{ photo.large }}" alt="" class="aspect-square w-full object-cover sm:rounded-lg">
            <span id="credit" class="absolute text-sm bg-gray-50 opacity-90 p-1 rounded-tr-md" style="bottom:0;">{{ photo.credit }}</span>
          </div>
        </div>

      </div>

      <div class="mt-10 px-4 sm:mt-16 sm:px-0 lg:mt-0">
        {% if details.common_name %}
          <h1 class="text-3xl font-bold tracking-tight text-gray-900 mb-1">{{ details.common_name }}</h1>
        {% endif %}
        <p class="text-3xl tracking-tight text-gray-900"><em>{{ info }}</em></p>

        {% if info.features %}
          <section class="container mx-auto features mt-5">
            <div class="grid grid-cols-2 gap-4">
              {% for each in info.features.all %}
                {% ifchanged each.species_type %}
                  {% if not forloop.first %}
                  </div>
                  {% endif %}
                  <div class="bg-gray-100 p-3 rounded">
                  <h3 class="text-sky-700">{{ each.get_species_type_display }}</h3>
                {% endifchanged %}
                <div class="mb-1">
                  {% if each.icon or each.icon_svg %}
                    <span class="mr-1 relative">
                      {{ each.get_icon }}
                    </span>
                  {% endif %}
                  <a href="/species/list/?feature={{ each.id }}" class="text-gray-700 hover:text-black font-normal hover:underline no-underline">
                    {{ each }}
                  </a>
                </div>
              {% endfor %}
            </div>
          </section>

        {% endif %}

        {% if info.colors.all or info.flowering %}
          <div class="rounded bg-gray-100 mt-5 p-3">
            <div class="flex justify-between">
              <h3 class="text-sky-700">{{ _("Flowering") }}</h3>
              <ul>
                {% for color in info.colors.all %}
                  <li class="colorbox" style="background:{{ color.color }}" title="{{ color }}">
                    <span class="sr-only">{{ color }}</span>
                  </li>
                {% endfor %}
              </ul>
            </div>
            {% if info.flowering %}
              <div>
                {% for month in info.flowering_months %}
                    <span class="badge-success">{{ month }}</span>
                {% endfor %}
              </div>
            {% endif %}
          </div>
        {% endif %}

        <p class="mt-6 text-base/7 text-gray-600">
          {% if details.description %}
          {{ details.description|linebreaksbr }}
          {% elif details.description_wikipedia %}
            {% if details.summary_wikipedia %}
              <strong>{{ details.summary_wikipedia|linebreaksbr }}</strong><br><br>
            {% endif %}
            {{ details.description_wikipedia|linebreaksbr }}
          {% endif %}
        </p>


        {% if sources %}
          <h3 class="mt-10">{{ _("Inclusion rationale") }}</h3>

          <p>{{ _("Why did we include this species on our website? Because it was mentioned in the following source(s):") }}</p>

          <ul class="list-disc ml-4 mt-3">
            {% for each in sources %}
              <li><a href="{% url "species_source" each.file.attached_to.id %}">{{ each.file.attached_to }}</a></li>
            {% endfor %}
          </ul>
        {% endif %}

      </div>
    </div>
  </div>

  <div class="px-4 sm:px-6 lg:px-8 pb-10">
    {% if details.propagation_seed or details.propagation_cutting %}
      <div class="lg:grid lg:grid-cols-2 lg:items-start lg:gap-x-8 bg-gray-100 p-5 mb-5 rounded">
        {% if details.propagation_seed %}
          <section>
            <h3>{{ _("Propagation by seed") }}</h3>
            {{ details.propagation_seed|linebreaksbr }}
          </section>
        {% endif %}

        {% if details.propagation_cutting %}
          <section>
            <h3>{{ _("Propagation by cutting") }}</h3>
            {{ details.propagation_cutting|linebreaksbr }}
          </section>
        {% endif %}
      </div>
    {% endif %}

    {% if garden %}
      <section class="bg-gray-100 rounded p-5">
        <h3><i class="fas fa-shovel"></i> {{ _("Garden planner") }} - {{ garden }}</h3>
        <div class="flex justify-between">
          <div>
            <button data-species="{{ info.id }}" data-action="PRESENT" class="planner-action {% if in_garden.status == "PRESENT" %}btn-green{% else %}btn-white{% endif %} mb-3 mr-3 cursor-pointer">
              <i class="fa fa-check-circle mr-1"></i>
              <i class="fa fa-certificate mr-1"></i>
              {{ _("I have this in my garden") }}
            </button>
            <button data-species="{{ info.id }}" data-action="FUTURE" class="planner-action {% if in_garden.status == "FUTURE" %}btn-green{% else %}btn-white{% endif %} mb-3 mr-3 cursor-pointer">
              <i class="fa fa-check-circle mr-1"></i>
              <i class="fa fa-certificate mr-1"></i>
              {{ _("I want this in my garden") }}
            </button>
          </div>
          <div>
          <a href="{% url "planner" garden.id %}" class="no-underline rounded-md bg-orange-600 px-3.5 py-2.5 text-sm font-semibold text-white shadow-xs hover:text-white hover:bg-orange-500 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-orange-600 flex mb-3 mr-3">
            <i class="fa fa-shovel mr-2 relative" style="top:2px"></i>
            {{ _("Go to garden planner") }}
          </a>
          </div>
        </div>
      </section>
    {% endif %}

    <section>
      <h3 class="mt-10">{{ _("Sources and references") }}</h3>
      <ul class="flex flex-wrap list-none">
      {% for label,url in info.get_links.items %}
        <li>
          <a href="{{ url }}" class="btn-blue mr-2">
            <i class="fa fa-link mr-1"></i> 
            {{ label }}
          </a>
        </li>
      {% endfor %}

        <li>
          <a href="{% url "species_data" info.id %}" class="btn-blue">
            <i class="fa fa-info mr-2"></i>
            {{ _("Data sources") }}
          </a>
        </li>
      </ul>
    </section>

  </div>

  {% if request.user.is_staff %}
    <a class="btn-warning btn-edit" href="{% url "controlpanel_species" info.id %}?redirect={{ request.get_full_path }}">
      <i class="fa fa-pencil"></i>
    </a>
  {% endif %}

  {% if garden %}
    <script type="text/javascript">
    $(function(){
      $("button.planner-action").on("click", function(e) {
        
        var button = $(this);
        var action = $(this).data("action");
        var species = $(this).data("species");
        $.ajax({
          url: "/species/"+species+"/",
          method: "POST",
          data: {
            action: action,
          },
          dataType: "json",
          success: function(response) {
            if (response.success) {
              $("#dialog").show();
              $("button.planner-action").removeClass("btn-green");
              $("button.planner-action").addClass("btn-white");
              button.addClass("btn-green");
            } else {
              alert("{{ _("Sorry, we were not able to record this species. Reload the page and try again.") }} Error code: 16.");
            }
          },
          error: function(xhr, status, error) {
            console.error("AJAX Error:", error);
            alert("{{ _("Sorry, we were not able to record this species. Reload the page and try again.") }} Error code: 17.");
          }
        });
      });

      $("#close_modal").click(function(){
        $("#dialog").hide();
      });

    });
    </script>

    <el-dialog>
      <dialog id="dialog" aria-labelledby="dialog-title" class="z-100 fixed inset-0 size-auto max-h-none max-w-none overflow-y-auto bg-transparent backdrop:bg-transparent">
        <el-dialog-backdrop class="fixed inset-0 bg-gray-500/75 transition-opacity data-closed:opacity-0 data-enter:duration-300 data-enter:ease-out data-leave:duration-200 data-leave:ease-in dark:bg-gray-900/50"></el-dialog-backdrop>

        <div tabindex="0" class="flex min-h-full items-end justify-center p-4 text-center focus:outline-none sm:items-center sm:p-0">
          <el-dialog-panel class="relative transform overflow-hidden rounded-lg bg-white px-4 pt-5 pb-4 text-left shadow-xl transition-all data-closed:translate-y-4 data-closed:opacity-0 data-enter:duration-300 data-enter:ease-out data-leave:duration-200 data-leave:ease-in sm:my-8 sm:w-full sm:max-w-lg sm:p-6 data-closed:sm:translate-y-0 data-closed:sm:scale-95 dark:bg-gray-800 dark:outline dark:-outline-offset-1 dark:outline-white/10">
            <div>
              <div class="mx-auto flex size-12 items-center justify-center rounded-full bg-green-100">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" data-slot="icon" aria-hidden="true" class="size-6 text-green-600">
                  <path d="m4.5 12.75 6 6 9-13.5" stroke-linecap="round" stroke-linejoin="round" />
                </svg>
              </div>
              <div class="mt-3 text-center sm:mt-5">
                <h3 id="dialog-title" class="text-base font-semibold text-gray-900">
                  {{ _("Information saved.") }}
                </h3>
                <div class="mt-2">
                  <p class="text-sm text-gray-500 dark:text-gray-400">
                    {{ _("The species was added to your garden") }}
                    (<strong>{{ garden }}</strong>).
                  </p>
                </div>
              </div>
            </div>
            <div class="mt-5 sm:mt-6 sm:grid sm:grid-flow-row-dense sm:grid-cols-2 sm:gap-3">
              <a href="{% url "planner_plants" garden.id %}" class="inline-flex w-full justify-center rounded-md bg-orange-600 px-3 py-2 text-sm font-semibold text-white shadow-xs hover:bg-orange-500 focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-orange-600 sm:col-start-2 no-underline">
                <i class="fas fa-shovel mr-2"></i>
                {{ _("View my plants") }}
              </a>
              <button type="button" id="close_modal" class="mt-3 inline-flex w-full justify-center rounded-md bg-white px-3 py-2 text-sm font-semibold text-gray-900 shadow-xs inset-ring-1 inset-ring-gray-300 hover:bg-gray-50 sm:col-start-1 sm:mt-0 cursor-pointer">
                {{ _("Close") }}
              </button>
            </div>
          </el-dialog-panel>
        </div>
      </dialog>
    </el-dialog>
  {% endif %}

{% endblock %}

{% block js %}
  <script type="text/javascript">
  $(function(){

    $(".gallery button").click(function(){
      var url = $(this).data("target");
      var credit = $(this).data("credit");
      img = $("#headshot img");
      thumbnail = $(this).find("img");
      img.attr("src", thumbnail.attr("src")); // While the large image loads, we show the thumbnail (instantly as it's already shown on page)
      img.attr("src", url);
      $("#credit").html(credit);
      $(".gallery button .ring-sky-500").removeClass("ring-sky-500").addClass("ring-transparent");
      $(this).find(".ring-2").removeClass("ring-transparent").addClass("ring-sky-500");
    });

    $("#refresh").click(function(){
      $("#inat_modal").show("fast");
    });

  });
  </script>
{% endblock %}
