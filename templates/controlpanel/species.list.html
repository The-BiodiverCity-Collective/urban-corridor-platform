{% extends "_base.html" %}
{% load i18n %}

{% block content %}

{% if request.GET.name %}
<div class="bg-gray-100 p-10 mb-10 rounded-2xl">
  <h2>Search entire species list</h2>
  <form method="get" action="" class="space-y-6">

    <div class="mb-4">
      <input type="text" placeholder="Species name" name="name" id="id_name" value="{{ request.GET.name }}" class="mt-1" required>
    </div>

    <div class="mt-6 flex items-center justify-end gap-x-6">
      <button type="submit" class="px-4 py-2 bg-lime-600 hover:bg-lime-700 text-white font-bold rounded-md focus:outline-hidden focus:ring-3 focus:ring-lime-300">
        {{ _("Search") }}
      </button>
    </div>
  </form>
</div>
{% elif filter_text %}
  <div class="alert alert-warning">
    {{ _("The following filters are active:") }}
    <ul class="pl-6 list-disc">
      {% for each in filter_text %}
        <li>{{ each }}</li>
      {% endfor %}
    </ul>
  </div>
{% endif %}

{% if not request.GET.name %}
  <h1>{{ _("Plant list") }}</h1>

  <div class="flex justify-between mb-3">
    <button id="process-btn" class="flex btn-blue items-center">
      <span id="btn-text">{{ _("Load missing iNat info") }}</span>
      <svg id="loading-spinner" class="hidden w-4 h-4 animate-spin text-white ml-2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor">
        <circle cx="12" cy="12" r="10" stroke-width="4" stroke="currentColor" stroke-opacity="0.25"></circle>
        <path fill="none" stroke="currentColor" stroke-width="4" d="M4 12a8 8 0 1 1 8 8"></path>
      </svg>
      <span id="pending-count" class="ml-2 hidden"></span>
    </button>

    {% if source %}
      <a href="{% url "species_source" source.id %}" class="btn btn-orange">
        {{ _("View species on website") }}
      </a>
    {% endif %}

    {% if "check_names" in request.GET %}
      <form method="post" class="inline">
        <button class="btn-green">{{ _("Save new names") }}</a>
        {% csrf_token %}
      </form>
    {% elif not "import" in request.GET %}
      <a href="?check_names{% if request.GET.file %}&amp;file={{ request.GET.file }}{% endif %}" class="btn-blue">{{ _("Check latest common names") }}</a>
    {% endif %}
  </div>

{% else %}
  <h1>Results</h1>
{% endif %}

<table class="table mb-5 datatable">
  <thead>
    <tr>
      <th>Name</th>
      <th>iNat</th>
      <th>IUCN</th>
      <th>SANBI</th>
      {% if request.GET.photos %}
        <th>Photos</th>
      {% endif %}
    </tr>
  </thead>
  <tbody>
  {% for each in species %}
    <tr {% if each.meta_data.inat %}class="inat"{% endif %}>
      <td>
        <em>
        <a href="{% url "controlpanel_species" each.id %}?next={{ request.get_full_path }}">{{ each.name }}</a>
        </em>
        - 
        {% if each.name_en %}
          {{ each.name_en }}
        {% else %}
          <span class="text-red-600">{{ _("No common name available") }}
        {% endif %}
        {% if "check_names" in request.GET %}
          <br>
          <span class="text-lime-600">{{ _("New iNat name") }}: <strong>{{ each.meta_data.inat.preferred_common_name }}</strong></span>
        {% endif %}

      </td>
      <td data-sort="{% if each.meta_data.inat %}1{% else %}0{% endif %}">{% if each.meta_data.inat %}<i class="fa fa-check"></i>{% else %}<i class="fa fa-minus-circle" data-id="{{ each.id }}"></i>{% endif %}</td>
      <td>{{ each.get_conservation_status|default_if_none:"" }}</td>
      <td>{{ each.get_sanbi_conservation_status|default_if_none:"" }}</td>
      {% if request.GET.photos %}
        <td data-sort="{{ each.photos.count }}">{{ each.photos.count }}</td>
      {% endif %}
    </tr>
  {% endfor %}
  </tbody>
</table>

{% if not source %}
  <a class="btn-blue" href="{% url "controlpanel_species" %}{% if request.GET.name %}?name={{ request.GET.name }}{% endif %}">
    <i class="fa fa-plus-square mr-1"></i> {{ _("Create new species") }}
  </a>
{% endif %}

{% if "import" in request.GET %}
  <el-dialog>
    <dialog id="dialog" aria-labelledby="dialog-title" class="z-100 block fixed inset-0 size-auto max-h-none max-w-none overflow-y-auto bg-transparent backdrop:bg-transparent">
      <el-dialog-backdrop class="fixed inset-0 bg-gray-500/75 transition-opacity data-closed:opacity-0 data-enter:duration-300 data-enter:ease-out data-leave:duration-200 data-leave:ease-in"></el-dialog-backdrop>

      <div tabindex="0" class="flex min-h-full items-end justify-center p-4 text-center focus:outline-none sm:items-center sm:p-0">
        <el-dialog-panel class="relative transform overflow-hidden rounded-lg bg-white px-4 pt-5 pb-4 text-left shadow-xl transition-all data-closed:translate-y-4 data-closed:opacity-0 data-enter:duration-300 data-enter:ease-out data-leave:duration-200 data-leave:ease-in sm:my-8 sm:w-full sm:max-w-lg sm:p-6 data-closed:sm:translate-y-0 data-closed:sm:scale-95">
          <div>
            <div class="mx-auto flex size-12 items-center justify-center rounded-full bg-green-100">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" data-slot="icon" aria-hidden="true" class="size-6 text-green-600">
                <path d="m4.5 12.75 6 6 9-13.5" stroke-linecap="round" stroke-linejoin="round" />
              </svg>
            </div>
            <div class="mt-3 text-center sm:mt-5">
              <h3 id="dialog-title" class="text-base font-semibold text-gray-900">
                {{ _("Species import complete") }}
              </h3>
              <div class="mt-2">
                <p class="text-sm text-gray-500">
                  {{ _("All species information from your spreadsheet has been imported into the website. Great work!") }}
                  {{ _("You can now view the species on our website, or review the list here in the control panel.") }}
                </p>
                {% if inat_missing %}
                  <p>
                    {% if inat_missing == 1 %}
                    {% blocktranslate %}Note! There is species that do not have any iNat information available.{% endblocktranslate %}
                    {% else %}
                    {% blocktranslate %}Note! There are {{ inat_missing }} species that do not have any iNat information available.{% endblocktranslate %}
                    {% endif %}
                  </p>
                {% endif %}
              </div>
            </div>
          </div>
          <div class="mt-5 sm:mt-6 sm:grid sm:grid-flow-row-dense sm:grid-cols-2 sm:gap-3">
            <a href="{% url "species_source" source.id %}" class="inline-flex w-full justify-center rounded-md btn-orange px-3 py-2 text-sm font-semibold text-white shadow-xs focus-visible:outline-2 focus-visible:outline-offset-2 sm:col-start-2">
              {{ _("View species on website") }}
            </a>
            <button type="button" data-action="close" class="cursor-pointer mt-3 inline-flex w-full justify-center rounded-md bg-white px-3 py-2 text-sm font-semibold text-gray-900 shadow-xs inset-ring-1 inset-ring-gray-300 hover:bg-gray-100 sm:col-start-1 sm:mt-0">
              {{ _("Close") }}
            </button>
          </div>
        </el-dialog-panel>
      </div>
    </dialog>
  </el-dialog>
{% endif %}

{% endblock %}

{% block js %}
  <script type="text/javascript">
  $(function(){
    $("#dialog button[data-action='close']").click(function(){
      $("#dialog").removeClass("block").hide();
    });
    $("#process-btn").click(function() {
      $(".datatable").DataTable().destroy();
      $(".datatable tr.inat").hide();
      const $btn = $(this);
      const $spinner = $("#loading-spinner");
      const $btnText = $("#btn-text");
      const $pendingCount = $("#pending-count");
      const $icons = $(".fa-minus-circle");
      let pendingCountValue = $icons.length;

      // Show loading spinner and hide text
      $btnText.addClass("hidden");
      $spinner.removeClass("hidden");
      $pendingCount.removeClass("hidden").text(pendingCountValue);

      // Function to process each icon sequentially
      function processNextIcon(index) {
        if (index >= $icons.length) {
          // All done
          $spinner.addClass("hidden");
          $btnText.html("{{ _("Syncing is complete.") }}");
          $btnText.removeClass("hidden");
          $btn.removeClass("btn-blue").addClass("btn-green");
          $pendingCount.addClass("hidden");
          return;
        }

        const $icon = $($icons[index]);
        const dataId = $icon.data("id");

        $icon.removeClass("fa-minus-circle").addClass("fa-spinner fa-spin text-amber-500");

        $.ajax({
          url: "/controlpanel/ajax/get_inat_data/" + dataId + "/",
          method: "GET",
          success: function(response) {
            if (response.success) {
              $icon.removeClass("fa-spinner fa-spin text-amber-500").addClass("fa-check-circle text-lime-500");
            } else {
              $icon.removeClass("fa-spinner fa-spin text-amber-500").addClass("fa-times-circle text-red-500");
            }
          },
          error: function() {
            $icon.removeClass("fa-spinner fa-spin").addClass("fa-times-circle text-red-500");
          },
          complete: function() {
            pendingCountValue--;
            $pendingCount.text(pendingCountValue);
            processNextIcon(index + 1); // Move to the next icon
          }
        });
      }

      // Start processing from the first icon
      processNextIcon(0);
    });

  });
  </script>
{% endblock %}
