{% extends "_base.html" %}

{% block content %}

<h1 class="text-3xl">Search entire species list</h1>

<form method="get" action="" class="space-y-6 p-6">

  <div class="mb-4">
    <input type="text" placeholder="Species name" name="name" id="id_name" value="{{ request.GET.name }}" class="mt-1" required>
  </div>

  <div class="mt-6 flex items-center justify-end gap-x-6">
    <button type="submit" class="px-4 py-2 bg-lime-600 hover:bg-lime-700 text-white font-bold rounded-md focus:outline-hidden focus:ring-3 focus:ring-lime-300">
      {{ _("Search") }}
    </button>
  </div>
</form>

{% if not request.GET.name %}
<h1>Active plant list</h1>

<button id="process-btn" class="btn-blue flex items-center">
  <span id="btn-text">Process</span>
  <svg id="loading-spinner" class="hidden w-4 h-4 animate-spin text-white ml-2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor">
    <circle cx="12" cy="12" r="10" stroke-width="4" stroke="currentColor" stroke-opacity="0.25"></circle>
    <path fill="none" stroke="currentColor" stroke-width="4" d="M4 12a8 8 0 1 1 8 8"></path>
  </svg>
  <span id="pending-count" class="ml-2 hidden"></span>
</button>
{% else %}
<h1>Results</h1>
{% endif %}

<table class="table mb-5 datatable">
  <thead>
    <tr>
      <th>Name</th>
      <th>iNat</th>
      <th>IUCN</th>
      <th>SANBI</th>
      {% if request.GET.photos %}
        <th>Photos</th>
      {% endif %}
    </tr>
  </thead>
  <tbody>
  {% for each in species %}
    <tr {% if each.meta_data.inat %}class="inat"{% endif %}>
      <td><a href="{% url "controlpanel_species" each.id %}">{{ each.name }}</a></td>
      <td data-sort="{% if each.meta_data.inat %}1{% else %}0{% endif %}">{% if each.meta_data.inat %}<i class="fa fa-check"></i>{% else %}<i class="fa fa-minus-circle" data-id="{{ each.id }}"></i>{% endif %}</td>
      <td>{{ each.get_conservation_status|default_if_none:"" }}</td>
      <td>{{ each.get_sanbi_conservation_status|default_if_none:"" }}</td>
      {% if request.GET.photos %}
        <td data-sort="{{ each.photos.count }}">{{ each.photos.count }}</td>
      {% endif %}
    </tr>
  {% endfor %}
  </tbody>
</table>

<a class="btn-add" href="{% url "controlpanel_species" %}">Add species</a>

{% endblock %}

{% block js %}
  <script type="text/javascript">
  $(function(){
    $("#process-btn").click(function() {
      $(".datatable").DataTable().destroy();
      $(".datatable tr.inat").hide();
      const $btn = $(this);
      const $spinner = $("#loading-spinner");
      const $btnText = $("#btn-text");
      const $pendingCount = $("#pending-count");
      const $icons = $(".fa-minus-circle");
      let pendingCountValue = $icons.length;

      // Show loading spinner and hide text
      $btnText.addClass("hidden");
      $spinner.removeClass("hidden");
      $pendingCount.removeClass("hidden").text(pendingCountValue);

      // Function to process each icon sequentially
      function processNextIcon(index) {
        if (index >= $icons.length) {
          // All done
          $spinner.addClass("hidden");
          $btnText.removeClass("hidden");
          return;
        }

        const $icon = $($icons[index]);
        const dataId = $icon.data("id");

        $icon.removeClass("fa-minus-circle").addClass("fa-spinner fa-spin text-amber-500");

        $.ajax({
          url: "/controlpanel/ajax/get_inat_data/" + dataId + "/",
          method: "GET",
          success: function(response) {
            if (response.success) {
              $icon.removeClass("fa-spinner fa-spin text-amber-500").addClass("fa-check-circle text-lime-500");
            } else {
              $icon.removeClass("fa-spinner fa-spin text-amber-500").addClass("fa-times-circle text-red-500");
            }
          },
          error: function() {
            $icon.removeClass("fa-spinner fa-spin").addClass("fa-times-circle text-red-500");
          },
          complete: function() {
            pendingCountValue--;
            $pendingCount.text(pendingCountValue);
            processNextIcon(index + 1); // Move to the next icon
          }
        });
      }

      // Start processing from the first icon
      processNextIcon(0);
    });

  });
  </script>
{% endblock %}
