{% extends "_base.html" %}
{% load static %}
{% load humanize %}

{% block content %}

<div class="float-right relative" style="bottom:-10px">
  <a class="mr-2 bg-gray-300 text-orange-700 p-1" href="{% url "controlpanel_shapefile" info.id %}"><i class="fa-regular fa-file"></i></a>
  <a class="mr-2 p-1" href="{% url "controlpanel_shapefile_dataviz" info.id %}"><i class="fa fa-object-group"></i></a>
  <a class="mr-2 p-1" href="{% url "controlpanel_shapefile_form" info.id %}"><i class="fa fa-pencil"></i></a>
  <a class="p-1" href="{% url "map" info.id %}"><i class="fa fa-map"></i></a>
</div>

<h1 class="text-3xl">{% block title %}{{ info }}{% endblock %}</h1>

<div class="grid grid-cols-2 gap-4">
  <div class="bg-gray-200 p-4">

    <h3>Files</h3>
    <div class="mt-2 flex rounded-lg border border-dashed border-gray-900/25 px-6 py-10 mb-5">
      <ul>
        {% for each in info.attachments.all %}
        <li class="text-gray-800">
          <i class="fa-fw fa fa-{{ each.get_icon }}"></i>
          <a href="{{ each.file.url }}">
          {{ each.get_name }}
          </a>
          <span class="text-xs/5 text-gray-600">
            ({{ each.file.size|filesizeformat }})
          </span>
        </li>
        {% endfor %}
      </ul>
    </div>

    <h3>Shapefile Processing</h3>

    <p class="font-bold">
    {% if info.meta_data.single_reference_space %}
      Convert into a single reference space (named {{ info }})
    {% elif info.meta_data.group_spaces_by_name %}
      Group all spaces that have the same name
    {% else %}
      Each item becomes a new reference space 
    {% endif %}
    </p>

    <h3 class="mt-5">Plot</h3>
    {% if info.meta_data.shapefile_plot %}
      <img src="{% get_media_prefix %}{{ info.meta_data.shapefile_plot }}" alt="" />
    {% elif info.meta_data.shapefile_plot_error %}

        <div class="flex items-center p-4 bg-amber-50 border border-amber-500 text-amber-700 mb-3">
          <i class="fa fa-triangle-exclamation mr-2"></i>          
          <span class="font-medium">
            The plot could not be generated. This error was returned:
            <br>
            <span class="font-mono font-bold">
            {{ info.meta_data.shapefile_plot_error }}
            </span>
          </span>
        </div>
      
    {% endif %}

    <form method="post" class="mt-5">
      <input type="hidden" name="create_shapefile_plot" value="true" />
      {% csrf_token %}
      <button type="submit" class="px-4 py-2 bg-lime-600 hover:bg-lime-700 text-white font-bold rounded-md focus:outline-none focus:ring focus:ring-lime-300">
        {% if info.meta_data.shapefile_plot %}
          Re-generate plot
        {% else %}
          Create plot
        {% endif %}
      </button>
    </form>

  </div>
  <div class="bg-gray-300 p-4 flex flex-col justify-between">
    <div>
      <h3>Existing spaces ({{ info.spaces.count }})</h3>

      {% if info.spaces.all %}
        <ul class="list-disc ml-4 space-y-2 mt-2">
          {% for each in info.spaces.all %}
            {% if forloop.counter <= 20 %}
              <li class="text-gray-700"><a href="{{ each.get_absolute_url }}">{{ each }}</a></li>
            {% endif %}
          {% endfor %}
        </ul>
      {% else %}
        <p class="font-bold">No spaces have been loaded into the database yet.</p>
      {% endif %}

      {% if info.shpinfo %}
        <h3 class="mt-3">Shapefile details</h3>

        <span class="mr-4">
          <i class="text-gray-500 fa fa-fw
          {% if "LineString" in info.shpinfo.type %}
            fa-bars-staggered
          {% elif "Polygon" in info.shpinfo.type %}
            fa-draw-polygon
          {% elif "Point" in info.shpinfo.type %}
            fa-location-dot
          {% else %}
            fa-circle-question
          {% endif %}
          "></i>
          {{ info.shpinfo.type }}
        </span>

        <span class="mr-4">
          <i class="text-gray-500 fa fa-list fa-fw"></i>
          <strong>{{ info.shpinfo.fields|length }}</strong>
          fields
        </span>

        <span class="mr-4">
          <i class="text-gray-500 fa-regular fa-file fa-fw"></i>
          <strong>{{ info.shpinfo.count }}</strong>
          items
        </span>


      {% if info.spaces.count %}
        <h3 class="mt-3">Imported</h3>

        <span class="mr-4">
          <i class="text-gray-500 fa fa-fw
          {% if "LineString" in info.shpinfo.type %}
            fa-bars-staggered
          {% elif "Polygon" in info.shpinfo.type %}
            fa-draw-polygon
          {% elif "Point" in info.shpinfo.type %}
            fa-location-dot
          {% else %}
            fa-circle-question
          {% endif %}
          "></i>
          {{ info.shpinfo.type }}
        </span>

        <span class="mr-4">
          <i class="text-gray-500 fa fa-list fa-fw"></i>
          <strong>{{ info.meta_data.columns.import|length }}</strong>
          fields
        </span>

        <span class="mr-4">
          <i class="text-gray-500 fa-regular fa-file fa-fw"></i>
          <strong>{{ info.spaces.count }}</strong>
          items
        </span>

        <span class="mr-4">
          <i class="text-gray-500 fa fa-server fa-fw"></i>
          <strong>{{ size_in_bytes|filesizeformat }}</strong> estimated db size
        </span>

        {% if clip_boundaries %}
          <div class="mt-5">
            <span class="mr-4">
              <i class="text-gray-500 fa-solid fa-burst fa-fw"></i>
              Clipped to match the boundaries of
              <strong><a href="{{ clip_boundaries.get_absolute_url }}">{{ clip_boundaries }}</a></strong>
            </span>
          </div>
        {% endif %}

      {% else %}

        <h3 class="mt-3">Fields</h3>
        <ul class="list-disc ml-4 space-y-2 mt-2">
          {% for each in info.shpinfo.fields|slice:":20" %}
            <li class="text-gray-700">{{ each }}</li>
            {% endfor %}
        </ul>

        {% if info.shpinfo.fields|length > 20 %}
          <button id="view-all" class="text-blue-500 hover:underline mt-2">VIEW ALL</button>
      
          <ul id="extra-items" class="list-disc ml-4 mt-2 space-y-2 hidden">
            {% for each in info.shpinfo.fields|slice:"20:" %}
              <li class="extra text-gray-700">{{ each }}</li>
            {% endfor %}
          </ul>
        {% endif %}
      {% endif %}
    {% endif %}


    {% if info.meta_data.processing_error %}

        <div class="flex items-center p-4 bg-amber-50 border border-amber-500 text-amber-700 mb-3 mt-5">
          <i class="fa fa-triangle-exclamation mr-2"></i>          
          <span class="font-medium">
            The shapefile could not be loaded. Error:
            <br>
            <span class="font-mono font-bold">
            {{ info.meta_data.processing_error }}
            </span>
          </span>
        </div>
      
    {% endif %}

    </div>

    <form method="post">
      <div class="mt-6">
        {% if not info.shpinfo %}
          <button type="submit" class="px-4 py-2 bg-lime-600 hover:bg-lime-700 text-white font-bold rounded-md focus:outline-none focus:ring focus:ring-lime-300" name="load_shapefile_info" value="true">
            Load shapefile info
          </button>
        {% endif %}

        {% if info.shpinfo.count > 1000 and not info.meta_data.skip_size_check %}
          <div class="flex items-center p-4 bg-amber-50 border border-amber-500 text-amber-700 mb-4">
            <!-- Exclamation Triangle Icon -->
            <svg class="w-6 h-6 mr-3" fill="currentColor" viewBox="0 0 20 20">
              <path d="M8.257 3.099c.366-.737 1.368-.737 1.734 0l6.5 13c.366.737-.092 1.601-.866 1.601H2.623c-.774 0-1.232-.864-.866-1.601l6.5-13zM10 9a1 1 0 00-.993.883L9 10v2a1 1 0 002 0v-2a1 1 0 00-.883-.993L10 9zm0 4a1 1 0 00-.993.883L9 14a1 1 0 001 1h0a1 1 0 001-1v-1a1 1 0 00-.883-.993L10 13z"/>
            </svg>
            
            <!-- Alert Message -->
            <span class="font-medium">You have over 1,000 items. Make sure you really want to import that many items.</span>
          </div>
        {% endif %}

        {% if not info.shpinfo %}
          <button type="submit" class="px-4 py-2 bg-gray-500 text-gray-200 font-bold rounded-md focus:outline-none focus:ring focus:ring-gray-300 cursor-not-allowed" name="convert_shapefile" value="true" disabled>
            Classify and import
          </button>
        {% else %}
          <button type="submit" class="px-4 py-2 bg-lime-600 hover:bg-lime-700 text-white font-bold rounded-md focus:outline-none focus:ring focus:ring-lime-300" name="convert_shapefile" value="true">
            Classify and import
          </button>
        {% endif %}

      </div>
      {% csrf_token %}
    </form>

  </div>
</div>

  <form method="post" class="mt-10">

      <h3 class="text-xl">Clipping</h3>
      <p>Do you want to clip the shapefile so it only shows elements within your corridor? This is especially useful 
      if the shapefile covers a much larger area.</p>

      <select name="clip" class="mt-4 block w-full rounded-md border-0 py-1.5 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 focus:ring-2 focus:ring-inset focus:ring-sky-600 sm:max-w-xs sm:text-sm/6" required>
        <option value=""></option>
        {% for each in corridors %}
          <option value="{{ each.id }}">{{ each }}</option>
        {% endfor %}
      </select>
      <button type="submit" class="px-4 py-2 mt-4 bg-lime-600 hover:bg-lime-700 text-white font-bold rounded-md focus:outline-none focus:ring focus:ring-lime-300" name="convert_shapefile" value="true">
        Clip to these borders
      </button>
    {% csrf_token %}

  </form>


<h3 class="mb-2 mt-10">Meta data</h3>
{% for key,value in info.meta_data.items %}
  <p class="font-mono"><strong>{{ key }}</strong>: {{ value }}</p>
{% endfor %}

</div>

{% endblock %}

{% block js %}
<script>
  $(document).ready(function() {
    // Toggle the visibility of extra items when the button is clicked
    $("#view-all").on("click", function() {
      $("#extra-items").toggleClass("hidden");
      $(this).hide();
    });
  });
</script>
{% endblock %}
